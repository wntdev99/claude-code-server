import fs from 'node:fs';
import path from 'node:path';
import type { Deliverable } from '@claude-code-server/shared';

/**
 * Scans workspace directories for deliverables generated by agents.
 */
export class DeliverableCollector {
  /**
   * Collect all files from a deliverable directory within a workspace.
   */
  collect(workspace: string, deliverableDir: string): Deliverable[] {
    if (!deliverableDir) return [];

    const fullPath = path.join(workspace, deliverableDir);

    if (!fs.existsSync(fullPath)) {
      return [];
    }

    return this.scanDirectory(fullPath, workspace);
  }

  private scanDirectory(dirPath: string, workspaceRoot: string): Deliverable[] {
    const deliverables: Deliverable[] = [];

    const entries = fs.readdirSync(dirPath, { withFileTypes: true });
    for (const entry of entries) {
      const entryPath = path.join(dirPath, entry.name);

      if (entry.isDirectory()) {
        // Skip node_modules, .git, etc.
        if (entry.name.startsWith('.') || entry.name === 'node_modules') {
          continue;
        }
        deliverables.push(...this.scanDirectory(entryPath, workspaceRoot));
      } else if (entry.isFile()) {
        try {
          const content = fs.readFileSync(entryPath, 'utf-8');
          const stats = fs.statSync(entryPath);
          deliverables.push({
            path: path.relative(workspaceRoot, entryPath),
            content,
            size: stats.size,
          });
        } catch {
          // Skip unreadable files
        }
      }
    }

    return deliverables;
  }
}
